# syntax=docker/dockerfile:1
# Build stage - installs packages that need compilation and clones the Space
FROM python:3.11.9-slim AS builder

ARG SPACE_URL=https://huggingface.co/spaces/denys-herasymuk/virnyflow-interface
ARG SPACE_BRANCH=main

# Basic OS deps (git, git-lfs for some Spaces, build tools for wheels)
RUN apt-get update && apt-get install -y --no-install-recommends \
    git git-lfs build-essential \
    swig \
    libgomp1 \
    gcc \
    g++ \
    findutils \
 && git lfs install \
 && rm -rf /var/lib/apt/lists/*

# Clone the Space
WORKDIR /app
RUN git clone --depth=1 -b ${SPACE_BRANCH} ${SPACE_URL} . \
 && rm -rf .git .gitattributes .gitignore

# Copy custom files
COPY ./configs/ /app/configs/
COPY ./mongo_patch.py /app/mongo_patch.py
COPY ./run_app_with_patch.py /app/run_app_with_patch.py

# Python deps
# (Speed up rebuilds: separate requirements layer)
RUN pip install --no-cache-dir --upgrade pip \
 && if [ -f requirements.txt ]; then pip install --no-cache-dir -r requirements.txt; fi

# Clean up unnecessary files from Python packages to reduce image size
RUN find /usr/local/lib/python3.11/site-packages -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true && \
    find /usr/local/lib/python3.11/site-packages -type d -name ".git" -exec rm -rf {} + 2>/dev/null || true

# Clean up application directory
RUN find /app -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true && \
    find /app -type d -name ".git" -exec rm -rf {} + 2>/dev/null || true

# Runtime stage - minimal image with only runtime dependencies
FROM python:3.11.9-slim

# Install only runtime system dependencies (no build tools)
RUN apt-get update && apt-get install -y --no-install-recommends \
    libgomp1 \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean \
    && rm -rf /tmp/* /var/tmp/*

# Copy Python packages from builder
COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

# Copy application files from builder
WORKDIR /app
COPY --from=builder /app /app

# Gradio server settings
ENV GRADIO_SERVER_NAME=0.0.0.0 \
    GRADIO_SERVER_PORT=7860 \
    PYTHONUNBUFFERED=1

# Expose Gradio port
EXPOSE 7860

# Default command runs the Space's app
CMD ["python", "app.py"]
